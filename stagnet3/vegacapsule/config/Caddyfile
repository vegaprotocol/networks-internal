{
  renew_interval 12h
}

(cors) {
  @cors_preflight method OPTIONS
  @cors header Origin {args.0}

  handle @cors_preflight {
    header Access-Control-Allow-Origin "{args.0}"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "*"
    header Access-Control-Max-Age "3600"
    respond "" 204
  }

  handle @cors {
    header Access-Control-Allow-Origin "{args.0}"
    header Access-Control-Expose-Headers "Link"
  }
}

(corepaths) {
	# (gRPC is direct to 3002)

	route /* {
		reverse_proxy http://localhost:3003
	}
}

(datanodepaths) {
	# GraphQL
	route /graphql {
		uri strip_prefix /graphql
		reverse_proxy http://localhost:3008
	}
	route /graphql/* {
		uri strip_prefix /graphql
		reverse_proxy http://localhost:3008
	}
	route /query {
		reverse_proxy http://localhost:3008
	}

	# REST
	route /* {
		reverse_proxy http://localhost:3009
	}
}

(tendermintpaths) {
	route / {
		reverse_proxy http://localhost:26657
	}
	route /* {
		reverse_proxy http://localhost:26657
	}
	# CORS headers for the Explorer
	header / Access-Control-Allow-Origin *
	header / Access-Control-Request-Method GET
	header /* Access-Control-Allow-Origin *
	header /* Access-Control-Request-Method GET
}

# Validators

n0{node_idx}.stagnet3.vega.xyz:443 {
  tls devops@vegaprotocol.io
	import corepaths
}

api.n0{node_idx}.stagnet3.vega.xyz:443 {
  tls devops@vegaprotocol.io
	import datanodepaths
}

tm.n0{node_idx}.stagnet3.vega.xyz:443 {
  tls devops@vegaprotocol.io
  import tendermintpaths
}
